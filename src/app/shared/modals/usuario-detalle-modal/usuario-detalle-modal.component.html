<ion-header>
  <ion-toolbar>
    <h1 class="detalle-titulo">Información del Usuario</h1>
    <ion-buttons slot="end">
      <ion-button (click)="cerrarModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="detalle-container">

    <!-- Estado de carga -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Cargando información del usuario...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !loading" class="error-container">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <h3>Error</h3>
      <p>{{ error }}</p>
      <ion-button fill="clear" (click)="cargarUsuario()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </div>

    <!-- Contenido del usuario -->
    <div *ngIf="usuario && !loading && !error">

      <!-- Sección de perfil principal -->
      <div class="detalle-section">
        <h3>
          <ion-icon name="person-outline"></ion-icon>
          Información Personal
        </h3>

        <div class="profile-card">
          <div class="profile-avatar">
            <span>{{ getInitials(usuario.nombre_completo) }}</span>
          </div>
          <div class="profile-details">
            <div class="user-name">{{ usuario.nombre_completo }}</div>
            <div class="user-status" [class.active]="usuario.is_active">
              <ion-icon name="checkmark-circle-outline" *ngIf="usuario.is_active"></ion-icon>
              <ion-icon name="close-circle-outline" *ngIf="!usuario.is_active"></ion-icon>
              {{ usuario.is_active ? 'Activo' : 'Inactivo' }}
            </div>
          </div>
        </div>

        <div class="info-items">
          <div class="info-item">
            <ion-icon name="mail-outline"></ion-icon>
            <div class="info-content">
              <span class="info-label">Correo electrónico</span>
              <span class="info-value">{{ usuario.correo }}</span>
            </div>
          </div>

          <div class="info-item">
            <ion-icon name="card-outline"></ion-icon>
            <div class="info-content">
              <span class="info-label">Cédula</span>
              <span class="info-value">{{ usuario.cedula }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="usuario.celular">
            <ion-icon name="call-outline"></ion-icon>
            <div class="info-content">
              <span class="info-label">Celular</span>
              <span class="info-value">{{ usuario.celular }}</span>
            </div>
          </div>

          <div class="info-item">
            <ion-icon name="location-outline"></ion-icon>
            <div class="info-content">
              <span class="info-label">Municipio</span>
              <span class="info-value">{{ usuario.municipio }}</span>
            </div>
          </div>

          <div class="info-item" *ngIf="usuario.lugar_votacion">
            <ion-icon name="business-outline"></ion-icon>
            <div class="info-content">
              <span class="info-label">Lugar de votación</span>
              <span class="info-value">{{ usuario.lugar_votacion }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de rol y permisos -->
      <div class="detalle-section">
        <h3>
          <ion-icon name="shield-outline"></ion-icon>
          Rol y Permisos
        </h3>
        <div class="role-permissions-container">

          <div class="role-card">
            <ion-chip [color]="getRolColor()">
              <ion-icon name="person-circle-outline"></ion-icon>
              <ion-label>{{ getRolLabel() }}</ion-label>
            </ion-chip>
          </div>

          <div class="permissions-container" *ngIf="getPermissionsList().length > 0">
            <div class="permissions-title">Permisos activos:</div>
            <div class="permissions-grid">
              <ion-chip *ngFor="let permiso of getPermissionsList()" color="success">
                <ion-icon name="checkmark-circle"></ion-icon>
                <ion-label>{{ permiso }}</ion-label>
              </ion-chip>
            </div>
          </div>
        </div>

      </div>

      <!-- Sección de métricas -->
      <div class="detalle-section">
        <h3>
          <ion-icon name="analytics-outline"></ion-icon>
          Métricas y Estadísticas
        </h3>

        <div class="metrics-grid">
          <!-- Votantes registrados -->
          <div class="metric-card">
            <div class="metric-header">
              <ion-icon name="people-outline"></ion-icon>
              <span>Votantes Registrados</span>
            </div>
            <div class="metric-value">{{ usuario.registers || 0 }}</div>
          </div>

          <!-- Calificación -->
          <div class="metric-card">
            <div class="metric-header">
              <ion-icon name="star-outline"></ion-icon>
              <span>Calificación</span>
            </div>
            <div class="rating-display">
              <div class="rating-stars">
                <ion-icon
                  *ngFor="let star of [1,2,3,4,5]; let i = index"
                  [name]="i < getStarCount() ? 'star' : 'star-outline'"
                  [class]="i < getStarCount() ? 'star-filled' : 'star-empty'">
                </ion-icon>
              </div>
              <span class="rating-number">{{ usuario.rating || 0 }}/5</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Incidencias Reportadas -->
      <div class="detalle-section">
        <h3>
          <ion-icon name="newspaper-outline"></ion-icon>
          Incidencias Reportadas
        </h3>

        <!-- Loading incidencias -->
        <div *ngIf="incidenciasLoading" class="incidencias-loading">
          <ion-spinner size="small"></ion-spinner>
          <span>Cargando incidencias...</span>
        </div>

        <!-- Error incidencias -->
        <div *ngIf="incidenciasError && !incidenciasLoading" class="incidencias-error">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <span>{{ incidenciasError }}</span>
          <ion-button fill="clear" size="small" (click)="cargarIncidencias()">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Reintentar
          </ion-button>
        </div>

        <!-- Sin incidencias -->
        <div *ngIf="!incidenciasLoading && !incidenciasError && incidencias.length === 0" class="sin-incidencias">
          <ion-icon name="document-text-outline"></ion-icon>
          <p>Este usuario no ha reportado incidencias</p>
        </div>

        <!-- Tabla de incidencias -->
        <div *ngIf="!incidenciasLoading && !incidenciasError && incidencias.length > 0" class="incidencias-table">
          <!-- Resumen -->
          <div class="incidencias-resumen">
            <span class="total-incidencias">Total: {{ incidencias.length }} incidencias</span>
            <div class="estados-resumen">
              <ion-chip color="medium" size="small">
                <ion-label>Pendientes: {{ getCountByEstado('pendiente') }}</ion-label>
              </ion-chip>
              <ion-chip color="success" size="small">
                <ion-label>Publicadas: {{ getCountByEstado('publicada') }}</ion-label>
              </ion-chip>
              <ion-chip color="danger" size="small">
                <ion-label>Rechazadas: {{ getCountByEstado('rechazada') }}</ion-label>
              </ion-chip>
            </div>
          </div>

          <!-- Tabla responsive -->
          <div class="table-container">
            <table class="incidencias-tabla">
              <thead>
                <tr>
                  <th>Título</th>
                  <th>Categoría</th>
                  <th>Estado</th>
                  <th>Municipio</th>
                  <th>Fecha</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let incidencia of getIncidenciasPaginadas()">
                  <td class="titulo-cell">
                    <div class="titulo-content">
                      <strong>{{ incidencia.titulo }}</strong>
                      <p class="descripcion-preview">{{ incidencia.descripcion | slice:0:50 }}{{ incidencia.descripcion.length > 50 ? '...' : '' }}</p>
                    </div>
                  </td>
                  <td class="categoria-cell">
                    <div class="categoria-badge">
                      <ion-icon [name]="getCategoriaIcon(incidencia.categoria)"></ion-icon>
                      <span>{{ getCategoriaText(incidencia.categoria) }}</span>
                    </div>
                  </td>
                  <td class="estado-cell">
                    <ion-chip [class]="getEstadoClass(incidencia.estado)" size="small">
                      {{ getEstadoText(incidencia.estado) }}
                    </ion-chip>
                  </td>
                  <td class="municipio-cell">
                    <ion-icon name="location-outline"></ion-icon>
                    {{ incidencia.ciudad_nombre }}
                  </td>
                  <td class="fecha-cell">
                    {{ formatDate(incidencia.fecha_creacion) }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Paginación -->
          <div class="pagination" *ngIf="totalPages > 1">
            <ion-button
              fill="clear"
              size="small"
              [disabled]="currentPage === 1"
              (click)="changePage(currentPage - 1)">
              <ion-icon name="chevron-back-outline"></ion-icon>
            </ion-button>

            <ion-button
              *ngFor="let page of getPages()"
              [fill]="page === currentPage ? 'solid' : 'clear'"
              size="small"
              [color]="page === currentPage ? 'primary' : 'medium'"
              (click)="changePage(page)">
              {{ page }}
            </ion-button>

            <ion-button
              fill="clear"
              size="small"
              [disabled]="currentPage === totalPages"
              (click)="changePage(currentPage + 1)">
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </div>


      <!-- Información adicional -->
      <div class="detalle-section">
        <h3>
          <ion-icon name="information-circle-outline"></ion-icon>
          Información Adicional
        </h3>

        <div class="additional-items">
          <div class="additional-item">
            <span class="additional-label">Registrado el:</span>
            <span class="additional-value">{{ formatearFecha(usuario.created_at) }}</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</ion-content>
