<ion-header>
  <app-main-header
    [nombre]="'Yamid Sanabria'"
    [avatar]="'assets/img/foto.png'"
    (logout)="logout()"
  ></app-main-header>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Incidencias Comunitarias</ion-title>
    </ion-toolbar>
  </ion-header>

  <!-- Navigation Tabs -->
  <div class="tabs-container">
    <ion-segment [(ngModel)]="tabActivo" (ionChange)="cambiarTab($event.detail.value)">
      <ion-segment-button value="incidencias">
        <!-- <ion-icon name="newspaper-outline"></ion-icon> -->
        <ion-label>Ver Incidencias</ion-label>
      </ion-segment-button>
      <ion-segment-button value="gestionar" *ngIf="esAdmin()">
        <!-- <ion-icon name="settings-outline"></ion-icon> -->
        <ion-label>Gestionar</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- TAB: VER INCIDENCIAS (PÚBLICO) -->
  <div *ngIf="tabActivo === 'incidencias'" class="tab-content">
    <!-- Filtros y Búsqueda -->
    <div class="filtros-container">
      <ion-card class="seccion-card">
        <div class="seccion-header" (click)="toggleSection('filtros')" [class.expanded]="expandedSection === 'filtros'">
          <div class="seccion-title">
            <ion-icon name="options-outline"></ion-icon>
            <ion-card-title>Filtros y Búsqueda</ion-card-title>
            <ion-badge color="primary" *ngIf="tieneFiltrosActivos()">Activos</ion-badge>
          </div>
          <ion-icon name="chevron-down-outline"></ion-icon>
        </div>
        <ion-card-content *ngIf="expandedSection === 'filtros'">
          <!-- Primera fila: Búsqueda de texto | Limpiar todo -->
          <ion-row>
            <ion-col size="8">
              <ion-searchbar
                [(ngModel)]="textoBusqueda"
                placeholder="Buscar por título o descripción..."
                (ionInput)="buscarIncidencias($event)"
                (ionClear)="limpiarBusqueda()"
                show-clear-button="focus"
                debounce="300">
              </ion-searchbar>
            </ion-col>
            <ion-col size="4">
              <ion-button expand="block" fill="clear" (click)="limpiarFiltros()" class="limpiar-btn">
                <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
                Limpiar Todo
              </ion-button>
            </ion-col>
          </ion-row>

          <!-- Segunda fila: Categoría | Municipio | Buscar -->
          <ion-row>
            <ion-col size="4">
              <ion-select [(ngModel)]="filtroCategoria" placeholder="Categoría" (ionChange)="aplicarFiltros()" class="filter-select">
                <ion-select-option value="">Todas</ion-select-option>
                <!-- <ion-select-option value="infraestructura">Infraestructura</ion-select-option> -->
                <!-- <ion-select-option value="servicios_publicos">Servicios Públicos</ion-select-option> -->
                <ion-select-option value="social">Social</ion-select-option>
                <ion-select-option value="seguridad">Seguridad</ion-select-option>
                <!-- <ion-select-option value="medio_ambiente">Medio Ambiente</ion-select-option> -->
                <!-- <ion-select-option value="transporte">Transporte</ion-select-option> -->
                <ion-select-option value="salud">Salud</ion-select-option>
                <ion-select-option value="ambiental">Ambiental</ion-select-option>
                <ion-select-option value="otros">Otros</ion-select-option>
              </ion-select>
            </ion-col>
            <ion-col size="4">
              <ion-select [(ngModel)]="filtroMunicipio" placeholder="Municipio" (ionChange)="aplicarFiltros()" class="filter-select">
                <ion-select-option value="">Todos</ion-select-option>
                <ion-select-option *ngFor="let municipio of municipios" [value]="municipio.id">
                  {{municipio.nombre}}
                </ion-select-option>
              </ion-select>
            </ion-col>
            <ion-col size="4">
              <ion-button expand="block" fill="solid" (click)="aplicarFiltros()" class="search-btn">
                <ion-icon name="search-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Lista de Incidencias Públicas -->
    <div class="incidencias-container">
      <div class="section-header">
        <h3>Incidencias Reportadas</h3>
        <div class="header-actions">
          <p>Total: {{totalIncidencias}} incidencias</p>
          <ion-button fill="solid" (click)="abrirModalCrear()">
            <ion-icon name="add-outline" slot="start"></ion-icon>
            Nueva Incidencia
          </ion-button>
        </div>
      </div>

      <div *ngIf="loading" class="loading-container">
        <ion-spinner></ion-spinner>
        <p>Cargando incidencias...</p>
      </div>

      <div *ngIf="!loading && incidenciasPublicas.length === 0" class="empty-state">
        <ion-icon name="document-outline"></ion-icon>
        <h4>No hay incidencias</h4>
        <p>No se encontraron incidencias con los filtros seleccionados.</p>
      </div>

      <ion-card *ngFor="let incidencia of incidenciasPublicas" class="incidencia-card" (click)="abrirDetalleIncidencia(incidencia)">
        <ion-card-header>
          <ion-card-subtitle>
            <ion-badge [color]="getCategoriaColor(incidencia.categoria)">
              {{getCategoriaLabel(incidencia.categoria)}}
            </ion-badge>
            <span class="fecha">{{incidencia.fecha_creacion ? formatearFecha(incidencia.fecha_creacion) : 'Sin fecha'}}</span>
          </ion-card-subtitle>
          <ion-card-title>{{incidencia.titulo}}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{incidencia.descripcion}}</p>
          <div class="incidencia-meta">
            <ion-chip>
              <ion-icon name="location-outline"></ion-icon>
              <ion-label>{{getMunicipioNombre(incidencia.ciudad_id, incidencia.ciudad_nombre)}}</ion-label>
            </ion-chip>
            <ion-chip>
              <ion-icon name="person-outline"></ion-icon>
              <ion-label>{{incidencia.usuario_nombre || 'Usuario desconocido'}}</ion-label>
            </ion-chip>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Paginación -->
      <div class="pagination-container" *ngIf="!loading && totalPages > 1">
        <ion-button fill="clear" [disabled]="currentPage === 1" (click)="irPagina(currentPage - 1)">
          <ion-icon name="chevron-back-outline"></ion-icon>
          Anterior
        </ion-button>
        <span class="page-info">Página {{currentPage}} de {{totalPages}}</span>
        <ion-button fill="clear" [disabled]="currentPage === totalPages" (click)="irPagina(currentPage + 1)">
          Siguiente
          <ion-icon name="chevron-forward-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Botón flotante para crear incidencia -->
    <!-- <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button (click)="abrirModalCrear()">
        <ion-icon name="add"></ion-icon>
      </ion-fab-button>
    </ion-fab> -->
  </div>

  <!-- TAB: GESTIONAR (ADMIN) -->
  <div *ngIf="tabActivo === 'gestionar' && esAdmin()" class="tab-content">
    <div class="admin-header">
      <h3>Gestión de Incidencias</h3>
      <p>Panel de administración para revisar y gestionar incidencias</p>
    </div>

    <div *ngIf="loadingGestion" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Cargando datos de gestión...</p>
    </div>

    <!-- Sección Pendientes -->
    <ion-card class="seccion-card">
      <div class="seccion-header" (click)="toggleSection('pendientes')" [class.expanded]="expandedSection === 'pendientes'">
        <div class="seccion-title">
          <ion-icon name="time-outline"></ion-icon>
          <ion-card-title>Incidencias Pendientes</ion-card-title>
          <ion-badge color="warning">{{incidenciasPendientes.length}}</ion-badge>
        </div>
        <ion-icon name="chevron-down-outline"></ion-icon>
      </div>
      <ion-card-content *ngIf="expandedSection === 'pendientes'">
        <div *ngIf="incidenciasPendientes.length === 0" class="no-items">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <h4>No hay incidencias pendientes</h4>
          <p>Todas las incidencias han sido revisadas</p>
        </div>

        <div *ngIf="incidenciasPendientes.length > 0" class="admin-incidencias-container">
          <div *ngFor="let incidencia of incidenciasPendientes" class="admin-incidencia" (click)="abrirDetalleIncidencia(incidencia)">
            <div class="incidencia-info">
              <h4>{{incidencia.titulo}}</h4>
              <p>{{incidencia.descripcion.length > 120 ? (incidencia.descripcion | slice:0:120) + '...' : incidencia.descripcion}}</p>
              <div class="incidencia-details">
                <ion-chip [color]="getCategoriaColor(incidencia.categoria)">{{getCategoriaLabel(incidencia.categoria)}}</ion-chip>
                <ion-chip color="medium">{{getMunicipioNombre(incidencia.ciudad_id, incidencia.ciudad_nombre)}}</ion-chip>
                <ion-chip color="light">{{incidencia.usuario_nombre || 'Usuario desconocido'}}</ion-chip>
                <ion-chip color="light">{{incidencia.fecha_creacion ? formatearFecha(incidencia.fecha_creacion) : 'Sin fecha'}}</ion-chip>
              </div>
            </div>
            <div class="incidencia-actions" (click)="$event.stopPropagation()">
              <ion-button color="success" size="small" (click)="incidencia.id && aprobarIncidencia(incidencia.id)">
                <ion-icon name="checkmark-outline"></ion-icon>
                Aprobar
              </ion-button>
              <ion-button color="danger" size="small" (click)="incidencia.id && rechazarIncidencia(incidencia.id)">
                <ion-icon name="close-outline"></ion-icon>
                Rechazar
              </ion-button>
              <!-- <ion-button color="primary" size="small" (click)="editarIncidencia(incidencia)">
                <ion-icon name="create-outline"></ion-icon>
                Editar
              </ion-button> -->
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Sección Publicadas -->
    <ion-card class="seccion-card">
      <div class="seccion-header" (click)="toggleSection('publicadas')" [class.expanded]="expandedSection === 'publicadas'">
        <div class="seccion-title">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <ion-card-title>Incidencias Publicadas</ion-card-title>
          <ion-badge color="success">{{incidenciasPublicas.length}}</ion-badge>
        </div>
        <ion-icon name="chevron-down-outline"></ion-icon>
      </div>
      <ion-card-content *ngIf="expandedSection === 'publicadas'">
        <div *ngIf="incidenciasPublicas.length === 0" class="no-items">
          <ion-icon name="document-outline"></ion-icon>
          <h4>No hay incidencias publicadas</h4>
          <p>Las incidencias aprobadas aparecerán aquí</p>
        </div>

        <div *ngIf="incidenciasPublicas.length > 0" class="admin-incidencias-container">
          <div *ngFor="let incidencia of incidenciasPublicas" class="admin-incidencia" (click)="abrirDetalleIncidencia(incidencia)">
            <div class="incidencia-info">
              <h4>{{incidencia.titulo}}</h4>
              <p>{{incidencia.descripcion.length > 120 ? (incidencia.descripcion | slice:0:120) + '...' : incidencia.descripcion}}</p>
              <div class="incidencia-details">
                <ion-chip [color]="getCategoriaColor(incidencia.categoria)">{{getCategoriaLabel(incidencia.categoria)}}</ion-chip>
                <ion-chip color="medium">{{getMunicipioNombre(incidencia.ciudad_id, incidencia.ciudad_nombre)}}</ion-chip>
                <ion-chip color="light">{{incidencia.usuario_nombre || 'Usuario desconocido'}}</ion-chip>
                <ion-chip color="light">{{incidencia.fecha_creacion ? formatearFecha(incidencia.fecha_creacion) : 'Sin fecha'}}</ion-chip>
              </div>
            </div>
            <div class="incidencia-actions" (click)="$event.stopPropagation()">
              <!-- <ion-button color="primary" size="small" (click)="editarIncidencia(incidencia)">
                <ion-icon name="create-outline"></ion-icon>
                Editar
              </ion-button> -->
              <ion-button color="danger" size="small" (click)="incidencia.id && eliminarIncidencia(incidencia.id)">
                <ion-icon name="trash-outline"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Sección Rechazadas -->
    <ion-card class="seccion-card">
      <div class="seccion-header" (click)="toggleSection('rechazadas')" [class.expanded]="expandedSection === 'rechazadas'">
        <div class="seccion-title">
          <ion-icon name="close-circle-outline"></ion-icon>
          <ion-card-title>Incidencias Rechazadas</ion-card-title>
          <ion-badge color="danger">{{incidenciasRechazadas.length}}</ion-badge>
        </div>
        <ion-icon name="chevron-down-outline"></ion-icon>
      </div>
      <ion-card-content *ngIf="expandedSection === 'rechazadas'">
        <div *ngIf="incidenciasRechazadas.length === 0" class="no-items">
          <ion-icon name="ban-outline"></ion-icon>
          <h4>No hay incidencias rechazadas</h4>
          <p>Las incidencias rechazadas aparecerán aquí</p>
        </div>

        <div *ngIf="incidenciasRechazadas.length > 0" class="admin-incidencias-container">
          <div *ngFor="let incidencia of incidenciasRechazadas" class="admin-incidencia" (click)="abrirDetalleIncidencia(incidencia)">
            <div class="incidencia-info">
              <h4>{{incidencia.titulo}}</h4>
              <p>{{incidencia.descripcion.length > 120 ? (incidencia.descripcion | slice:0:120) + '...' : incidencia.descripcion}}</p>
              <div class="incidencia-details">
                <ion-chip [color]="getCategoriaColor(incidencia.categoria)">{{getCategoriaLabel(incidencia.categoria)}}</ion-chip>
                <ion-chip color="medium">{{getMunicipioNombre(incidencia.ciudad_id, incidencia.ciudad_nombre)}}</ion-chip>
                <ion-chip color="light">{{incidencia.usuario_nombre || 'Usuario desconocido'}}</ion-chip>
                <ion-chip color="light">{{incidencia.fecha_creacion ? formatearFecha(incidencia.fecha_creacion) : 'Sin fecha'}}</ion-chip>
              </div>
            </div>
            <div class="incidencia-actions" (click)="$event.stopPropagation()">
              <ion-button color="success" size="small" (click)="incidencia.id && aprobarIncidencia(incidencia.id)">
                <ion-icon name="checkmark-outline"></ion-icon>
                Aprobar
              </ion-button>
              <!-- <ion-button color="primary" size="small" (click)="editarIncidencia(incidencia)">
                <ion-icon name="create-outline"></ion-icon>
                Editar
              </ion-button> -->
              <ion-button color="danger" size="small" (click)="incidencia.id && eliminarIncidencia(incidencia.id)">
                <ion-icon name="trash-outline"></ion-icon>
                Eliminar
              </ion-button>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
